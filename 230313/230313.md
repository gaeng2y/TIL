# Thread Safety

## ì—¬ëŸ¬ ìŠ¤ë ˆë“œë¥¼ ì‚¬ìš©í•  ë•Œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œì 

```swift
import Foundation

var gaeng = 0

for i in 0...100000 {
    DispatchQueue.global().async {
        gaeng = i
    }
}

print(gaeng)
```

GCDë¥¼ ì´ìš©í•˜ê¸° ë•Œë¬¸ì— ë°ë“œë½ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

ê°™ì€ ìŠ¤ë ˆë“œì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì—

## Data Race Condition

ë°ì´í„° ë ˆì´ìŠ¤(ë°ì´í„° ê²½ìŸ ìƒíƒœ)ëŠ” ë©€í‹° ìŠ¤ë ˆë“œë¥¼ ì´ìš©í•˜ëŠ” í™˜ê²½ì—ì„œ, ê°™ì€ ë°ì´í„°ë¥¼ ì—¬ëŸ¬ ìŠ¤ë ˆë“œì—ì„œ ë™ì‹œì— ì½ê±°ë‚˜ ì“°ë ¤ê³  í•  ë•Œ ê²½ìŸí•˜ê²Œ ë˜ëŠ” í˜„ìƒ

## Dead Lock

êµì°©ìƒíƒœ(Dead Lock)ì€ ìƒí˜¸ ë°°ì œì— ì˜í•´ ë‚˜íƒ€ë‚˜ëŠ” ë¬¸ì œì ìœ¼ë¡œ, ë‘˜ ì´ìƒì˜ í”„ë¡œì„¸ìŠ¤ë“¤ì´ ìì›ì„ ì ìœ í•œ ìƒíƒœì—ì„œ ì„œë¡œ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ê°€ ì ìœ í•˜ê³  ìˆëŠ” ìì›ì„ ìš”êµ¬í•˜ë©° ë¬´í•œì • ê¸°ë‹¤ë¦¬ëŠ” í˜„ìƒ

## í•´ê²°ë°©ë²•

ì„¸ë§ˆí¬ì–´ëŠ” ë®¤íƒìŠ¤ì˜ ì¼ì¢…(Swiftì—ëŠ” mutax ì—†ìŒ)

## Semaphore

[https://developer.apple.com/documentation/dispatch/dispatchsemaphore](https://developer.apple.com/documentation/dispatch/dispatchsemaphore)

ê³µìœ ëœ ìì›ì˜ ë°ì´í„°Â í˜¹ì€ ì„ê³„ì˜ì—­(Critical Section) ë“±ì—Â **ì—¬ëŸ¬**Â **Process í˜¹ì€ Thread**ê°€ íŠ¹ì • ê°¯ìˆ˜ë§Œ ì ‘ê·¼í•˜ë„ë¡ í—ˆìš©í•˜ëŠ” ê²ƒ

```swift
var heesang = 0

let semaphore = DispatchSemaphore(value: 0)
for i in 1...1000 {
	DispatchQueue.global().async {
		heesang = i 
		semaphore.signal() // ë‹¤í–ˆìœ¼ë‹ˆ ëë‚¬ë‹¤ëŠ” ì‹ í˜¸
	}
	semaphore.wait() // í ë˜ì§€ê³  ë°”ë¡œ ê¸°ë‹¤ë ¤!
}

print(heesang)
```

- ì°¸ê³  : Mutax
    - ê³µìœ ëœ ìì›ì˜ ë°ì´í„° í˜¹ì€ ì„ê³„ì˜ì—­(Critical Section) ë“±ì—Â **í•˜ë‚˜ì˜ Process í˜¹ì€ Thread**ì˜ ì ‘ê·¼ë§Œ í—ˆìš©í•˜ëŠ” ê²ƒ

## Dispatch Group

[https://developer.apple.com/documentation/dispatch/dispatchgroup](https://developer.apple.com/documentation/dispatch/dispatchgroup)

ì„¸ë§ˆí¬ì–´ëŠ” í•˜ë‚˜ì˜ ì´ë²¤íŠ¸ì˜ ì™„ë£Œë§Œ ê¸°ë‹¤ë¦¬ì§€ë§Œ ê·¸ë£¹ì€ ì—¬ëŸ¬ê°œì˜ ì‘ì—…ì´ ì™„ë£Œ

# Swift Concurrency

## References

- [Swift Concurrency](https://docs.swift.org/swift-book/LanguageGuide/Concurrency.html)
- WWDC 2021
    - [Meet async/await in Swift](https://developer.apple.com/videos/play/wwdc2021/10132) - 33:38
    - [Explore structured concurrency in Swift](https://developer.apple.com/videos/play/wwdc2021/10134) - 27:54
    - [Protect mutable state with Swift actors](https://developer.apple.com/videos/play/wwdc2021/10133) - 28:32
    - [Swift concurrency: Behind the scenes](https://developer.apple.com/videos/play/wwdc2021/10254/) - 39:18
    - [Swift concurrency: Update a sample app](https://developer.apple.com/videos/play/wwdc2021/10194) - 1:00:59
    - [Use async/await with URLSession](https://developer.apple.com/videos/play/wwdc2021/10095) - 13:40
    - [Meet AsyncSequence](https://developer.apple.com/videos/play/wwdc2021/10058) - 14:21
- WWDC 2022
    - [Visualize and optimize Swift concurrency](https://developer.apple.com/videos/play/wwdc2022/110350) -  24:38
    - [Meet distributed actors in Swift](https://developer.apple.com/videos/play/wwdc2022/110356) - 25:16
    - [Eleminate data races using Swift Concurrency](https://developer.apple.com/videos/play/wwdc2022/110351) - 28:54
    

`21â€™~22â€™` `Swift Concurrencyë¥¼ ì£¼ì œë¡œí•œ WWDC Video Session ì‹œê°„ ì´í•© : 5:47:06`

â†’ 2ì‹œê°„ìœ¼ë¡œ ì•Œì§œë°°ê¸° ì •ë¦¬ ê°‘ë‹ˆë‹¤!

## Swift Concurrency ë“±ì¥ ë°°ê²½

<aside>
ğŸ’¡ Swift 5.5ì— ì–¸ì–´ ê¸°ëŠ¥ìœ¼ë¡œ ë“±ì¥ 
ì œì•ˆ : [[SE-0296: Async/await](https://github.com/apple/swift-evolution/blob/main/proposals/0296-async-await.md)]

</aside>

- Completion Handlerì˜ ë¶ˆí¸í•¨
    - ìˆœì„œê°€ ë’¤ì£½ë°•ì£½ì´ë¼ ì½ê³  ì“°ê¸°ê°€ ì–´ë ¤ì›€
        
        ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/1434cf84-e846-45ab-a38f-78b2afbdd402/Untitled.png)
        
    - ë²„ê·¸ ì–‘ì‚° - completion handler í˜¸ì¶œ ìŠì–´ë²„ë¦¬ê¸° / ì˜¤ë¥˜ì²˜ë¦¬ì˜ ì–´ë ¤ì›€
        
        ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/2022eba2-0aec-4634-afe7-0a26e71778c0/Untitled.png)
        
        ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/e903d65c-ec2b-4e5a-a179-c34334884a30/Untitled.png)
        
    - ì˜¤ë¥˜ì²˜ë¦¬ì™€ ë²„ê·¸ ë°©ì§€ë¥¼ ìœ„í•´ `Result` Typeì„ ì œì•ˆí•´ì„œ ì‚¬ìš©í–ˆì§€ë§Œ ì½”ë“œ ì–‘ì´ ëŠ˜ê³  ê¹”ë”í•˜ì§€ ì•ŠìŒ
    
    ## Concurrency
    
    ### Sync/Async
    
    **Sync Programming**
    
    í”„ë¡œê·¸ë¨ì˜ íë¦„ê³¼ ì´ë²¤íŠ¸ì˜ ë°œìƒ ë° ì²˜ë¦¬ë¥¼ ì¢…ì†ì ìœ¼ë¡œ ìˆ˜í–‰í•˜ëŠ” ë°©ë²• - ë™ê¸° í”„ë¡œê·¸ë˜ë°
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/97b9e8bd-e8d3-4bc3-8b3f-402576c32396/Untitled.png)
    
    **Async Programming**
    
    í”„ë¡œê·¸ë¨ì˜ íë¦„ê³¼ ì´ë²¤íŠ¸ì˜ ë°œìƒ ë° ì²˜ë¦¬ë¥¼ ë…ë¦½ì ìœ¼ë¡œ ìˆ˜í–‰í•˜ëŠ” ë°©ë²• - ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/9b613ab4-0cea-4952-a22d-b0dfdbbdbc2c/Untitled.png)
    
    <aside>
    â— **ì—¬ê¸°ì„œ ì ê¹!!  `ë¹„ë™ê¸° != ë™ì‹œì„±`**
    
    </aside>
    
    - **ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°**(Async)
    **í”„ë¡œê·¸ë¨ì˜ íë¦„**ê³¼ **ì´ë²¤íŠ¸ì˜ ë°œìƒ ë° ì²˜ë¦¬**ë¥¼ ë…ë¦½ì ìœ¼ë¡œ ìˆ˜í–‰í•˜ëŠ” ë°©ë²•
    - **ë™ì‹œì„± í”„ë¡œê·¸ë˜ë°**(Concurrency)
    ì—¬ëŸ¬ ì‘ì—…ì´ ë…¼ë¦¬ì ì¸ ê´€ì ì—ì„œ ë™ì‹œì— ìˆ˜í–‰ë˜ëŠ” ê²ƒ
    ì‹±ê¸€ ì½”ì–´ ë˜ëŠ” ë©€í‹° ì½”ì–´ì—ì„œ ë©€í‹° ìŠ¤ë ˆë”©ì„ í•˜ê¸° ìœ„í•´ ì ìš©
    - **ë³‘ë ¬ì„± í”„ë¡œê·¸ë˜ë°**(Parallel)
    ì—¬ëŸ¬ ì‘ì—…ì´ ë¬¼ë¦¬ì ì¸ ê´€ì ì—ì„œ ë™ì‹œì— ìˆ˜í–‰ë˜ëŠ” ê²ƒ
    
    > **ìš°ë¦¬ì—ê²Œ ìµìˆ™í•œ ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë° - `completion handler`**
    > 
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/5eeba726-a57d-4ed1-93bd-5b5946bc76fd/Untitled.png)
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ba5d5cdb-645f-481d-bb90-256154b779ab/Untitled.png)
    
    ## Swift Concurrency
    
    - async ëŠ” í•¨ìˆ˜ë¥¼ suspend ì‹œí‚¬ ìˆ˜ ìˆë‹¤
        - await í‚¤ì›Œë“œë¥¼ ë§Œë‚˜ë©´ ìŠ¤ë ˆë“œ blockì„ í•´ì œí•˜ê³  suspendë¨
        - ì¦‰, await í‚¤ì›Œë“œê°€ suspendë¥¼ ì‹œí‚¤ëŠ” ì§€ì 
        - suspend ëœ ì‘ì—…ì´ ìˆì„ ë•Œ, ë‹¤ë¥¸ ì‘ì—…ì´ ì§„í–‰ë  ìˆ˜ ìˆë‹¤
        
    
    ## Swift Concurrency
    
    `Perform asynchronous and parallel operations.`
    
    Key topics : async/await, Task, Continuation, AsyncSequence, AsyncStream, Actor, Sendable
    
    ### GCD vs Swift Concurrency
    
    - Task
    - Dispatch Queue
        - Main Queue / Global Queue
        - Serial Queue / Concurrent Queue
    
    ![wwdc2021-10254_hd.mp4 - 07.49.302.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/2ca7955c-c66b-4987-b568-22f805d8a97b/wwdc2021-10254_hd.mp4_-_07.49.302.png)
    
    - Task / Task Group
    - Main Actor / Actor
    - Continuation(Context Switching ë³´ë‹¤ ì €ë ´í•˜ê²Œ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.)
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/a3ced633-de83-4984-8dfd-ceead8bc4221/Untitled.png)
    
    ![wwdc2021-10254_hd.mp4 - 33.56.334.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/aa5af35e-6212-4648-9bef-4243ae7eb14d/wwdc2021-10254_hd.mp4_-_33.56.334.png)
    
    ![wwdc2021-10254_hd.mp4 - 34.11.048.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/717854b1-5dec-417f-9282-c79a376e8f2b/wwdc2021-10254_hd.mp4_-_34.11.048.png)
    
    ![wwdc2021-10254_hd.mp4 - 34.17.055.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/25d89b5d-ce81-452e-a048-bd838121b8ab/wwdc2021-10254_hd.mp4_-_34.17.055.png)
    
    ![wwdc2021-10254_hd.mp4 - 36.05.163.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/26ec82b0-559e-41fa-b7df-f2a3f3a1b1c1/wwdc2021-10254_hd.mp4_-_36.05.163.png)
    
    ![wwdc2021-10254_hd.mp4 - 36.17.175.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/21d7ef82-1532-48dd-863c-4eacfb1f4378/wwdc2021-10254_hd.mp4_-_36.17.175.png)
    
    ![wwdc2021-10254_hd.mp4 - 36.20.344.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/0db48ba2-5f86-4013-be18-2df3939e58f3/wwdc2021-10254_hd.mp4_-_36.20.344.png)
    
    - Swift Concurrency in Apple Frameworks
        - ëª‡ëª‡ SDKì—ì„œëŠ” Async APIë¥¼ ì œê³µí•¨
        - ìŠ¤ìœ„í”„íŠ¸ ì»´íŒŒì¼ëŸ¬ê°€ completion handlerë¥¼ í¬í•¨í•œ Objective-C APIë¥¼ ìë™ìœ¼ë¡œ async/awaitìœ¼ë¡œ
    
    ### async/await
    
    ![wwdc2022-110350_hd.mp4 - 01.33.093.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/aefca65c-0b3c-4c34-af9a-c5753a0fc050/wwdc2022-110350_hd.mp4_-_01.33.093.png)
    
    ```swift
    func listPhotos(inGallery name: String) async -> [String] {
      let result = // ... some asynchronous networking code ...
      return result
    }
    
    let photoNames = await listPhotos(inGallery: "Summer Vacation")
    let sortedNames = photoNames.sorted()
    let name = sortedNames[0]
    let photo = await downloadPhoto(named: name)
    show(photo)
    ```
    
    ```swift
    /// Wrong way..
    let firstPhoto = await listPhotos(inGallery: "Summer Vacation")[0]
    add(firstPhoto toGallery: "Road Trip")
    // At this point, firstPhoto is temporarily in both galleries.
    remove(firstPhoto fromGallery: "Summer Vacation")
    
    /// After Refactor
    func move(_ photoName: String, from source: String, to destination: String) {
        add(photoName, to: destination)
        remove(photoName, from: source)
    }
    // ...
    let firstPhoto = await listPhotos(inGallery: "Summer Vacation")[0]
    move(firstPhoto, from: "Summer Vacation", to: "Road Trip")
    ```
    
    `'async' must precede 'throws'`
    
    `'try' must precede 'await'`
    
    ### read-only async property
    
    ```swift
    extension UIImage {
    	var thumbnail: UIImage? {
        get async {
            let size = CGSize(width: 50, height: 50)
            return await self.resizedImage(ofSize: size)
        }
    	}
    }
    ```
    
    ### async-let
    
    ```swift
    func fetchThumbnails(urls: [URL]) async throws -> [UIImage] {
      let thumb0 = await fetchImage(from: url[0])
      let thumb1 = await fetchImage(from: url[1])
      let thumb2 = await fetchImage(from: url[2])
      let thumbs = [thumb0, thumb1, thumb2]
      return thumbs
    }
    
    func fetchThumbnails(urls: [URL]) async throws -> [UIImage] {
      async let thumb0 = fetchImage(from: url[0])
      async let thumb1 = fetchImage(from: url[1])
      async let thumb2 = fetchImage(from: url[2])
      let thumbs = try await [thumb0, thumb1, thumb2]
      return thumbs
    }
    ```
    
    ## Task
    
    ### Task
    
    > `@frozen struct Task<Success, Failure> where Success : [Sendable](https://developer.apple.com/documentation/swift/sendable), Failure : [Error](https://developer.apple.com/documentation/swift/error)`
    > 
    > 
    > A unit of asynchronous work.
    > 
    
    ![wwdc2022-110350_hd.mp4 - 01.33.093.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/aefca65c-0b3c-4c34-af9a-c5753a0fc050/wwdc2022-110350_hd.mp4_-_01.33.093.png)
    
    - ì„¸ ê°€ì§€ ìƒíƒœ : suspended / running / completed
    - ìš°ì„ ìˆœìœ„(`TaskPriority`) : background, high, low, medium, userInitiated, utility
    - async contextê°€ ì•„ë‹Œ ìƒí™©ì—ì„œ async contextë¡œ í¸ì…ì‹œí‚¤ëŠ” ì¥ì¹˜ë¡œ í™œìš©í•  ìˆ˜ ìˆìŒ
    
    ### Detached Task
    
    > The task thrown asynchronously as part of a new top-level task.
    > 
    
    ```swift
    @discardableResult static func detached(
        priority: TaskPriority? = nil,
        operation: @escaping () async throws -> Success
    ) -> Task<Success, Failure>
    ```
    
    Available whenÂ `Success`Â conforms toÂ `Sendable`Â andÂ `Failure`Â isÂ `Error`.
    
    ### Task Group
    
    > `@frozen struct TaskGroup<ChildTaskResult> where ChildTaskResult : [Sendable](https://developer.apple.com/documentation/swift/sendable)`
    A group that contains dynamically created child tasks.
    > 
    
    To create a task group, call theÂ `withTaskGroup(of:returning:body:)`Â method. Donâ€™t use a task group from outside the task where you created it.
    
    ```swift
    func fetchThumbnails(urls: [URL]) async throws -> [Int: UIImage] {
        var thumbnails: [Int: UIImage] = [:]
        try await withThrowingTaskGroup(of: (Int, UIImage).self) { group in
            for (index, url) in urls.enumerated() {
                group.addTask {
                    return (index, try await self.fetchImage(from: url))
                }
            }
            for try await (index, thumb) in group {
                thumbnails[index] = thumb
            }
        }
        return thumbnails
    }
    ```
    
    ### Task Cancellation
    
    - Operationê³¼ ë§ˆì°¬ê°€ì§€ë¡œ ì·¨ì†Œ ëª…ë ¹ì„ ì¤„ ìˆ˜ ìˆì§€ë§Œ ì‹¤ì œ êµ¬í˜„ë¶€ì—ì„œ ì·¨ì†Œì—¬ë¶€ë¥¼ íŒŒì•…í•˜ì—¬ ì‘ì—…ì„ ì¤‘ì§€í•˜ëŠ” í˜•íƒœ
    - `isCancelled` / `checkCancellation()`
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f5a52665-c400-474a-bc33-aa3f4baa8c83/Untitled.png)